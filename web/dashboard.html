<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1400" />
  <title>Support Team Dashboard</title>
  <link rel="stylesheet" href="css/tokens.css" />
  <link rel="stylesheet" href="css/dark.css" />
  <style>
    /* â”€â”€ Dashboard Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
      background: var(--ios-bg);
      color: var(--ios-text);
      min-height: 100vh;
      padding-top: 100px;
      padding-bottom: 40px;
      overflow: auto !important;
      overflow-x: hidden !important;
      display: block !important;
      align-items: unset !important;
    }
    /* Override tokens.css hidden scrollbar for dashboard */
    html::-webkit-scrollbar, body::-webkit-scrollbar {
      width: 8px !important; background: transparent;
    }
    html::-webkit-scrollbar-thumb, body::-webkit-scrollbar-thumb {
      background: var(--ios-gray3); border-radius: 4px;
    }
    html { overflow: auto !important; }

    /* â”€â”€ Nav Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(255,255,255,0.92);
      border-bottom: 1px solid var(--ios-separator);
      padding: 12px 24px;
    }
    .dash-nav-inner {
      max-width: 1400px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 8px;
    }
    .nav-back {
      color: var(--ios-blue); text-decoration: none;
      font-size: 15px; font-weight: 500;
      display: flex; align-items: center; gap: 4px;
    }
    .nav-back:hover { text-decoration: underline; }
    .dash-title {
      font-size: 20px; font-weight: 700;
      letter-spacing: -0.3px;
    }
    .dash-controls {
      display: flex; align-items: center; gap: 10px;
    }
    .dash-select {
      font-family: inherit; font-size: 14px;
      padding: 6px 12px; border-radius: 8px;
      border: 1px solid var(--ios-separator);
      background: var(--ios-card); color: var(--ios-text);
      cursor: pointer;
    }
    .dash-refresh {
      font-size: 18px; background: none; border: none;
      cursor: pointer; padding: 6px 10px; border-radius: 8px;
      color: var(--ios-blue);
    }
    .dash-refresh:hover { background: rgba(0,122,255,0.1); }
    .dash-timestamp {
      width: 100%; text-align: center;
      font-size: 12px; color: var(--ios-text3);
      margin-top: 4px;
    }

    /* â”€â”€ Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-container {
      max-width: 1400px; margin: 0 auto;
      padding: 24px;
    }

    /* â”€â”€ KPI Cards Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--ios-card);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    .kpi-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 4px;
    }
    .kpi-card.escalation::before { background: linear-gradient(90deg, var(--ios-blue), var(--ios-purple)); }
    .kpi-card.confirmed::before { background: var(--ios-green); }
    .kpi-card.failed::before { background: var(--ios-red); }
    .kpi-card.summary::before { background: linear-gradient(90deg, var(--ios-purple), var(--ios-blue)); }

    .kpi-label {
      font-size: 13px; font-weight: 600;
      color: var(--ios-text2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .kpi-value {
      font-size: 42px; font-weight: 700;
      letter-spacing: -1px;
      margin-bottom: 12px;
    }
    .kpi-value.green { color: var(--ios-green); }
    .kpi-value.red { color: var(--ios-red); }

    .tier-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 4px 0;
      font-size: 14px;
    }
    .tier-row + .tier-row {
      border-top: 1px solid var(--ios-separator);
    }
    .tier-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }
    .tier-badge.Platinum { background: linear-gradient(135deg, #9B59B6, #8E44AD); }
    .tier-badge.Gold { background: linear-gradient(135deg, #F39C12, #E67E22); }
    .tier-badge.Silver { background: linear-gradient(135deg, #BDC3C7, #95A5A6); color: #333; }
    .tier-badge.General { background: var(--ios-gray5); }

    .stat-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
    }
    .stat-row + .stat-row {
      border-top: 1px solid var(--ios-separator);
    }
    .stat-label { color: var(--ios-text2); }
    .stat-val { font-weight: 600; }
    .stat-val.green { color: var(--ios-green); }
    .stat-val.orange { color: var(--ios-orange); }
    .stat-val.red { color: var(--ios-red); }

    /* â”€â”€ Chart Cards Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .chart-card {
      background: var(--ios-card);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    .chart-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--ios-blue), var(--ios-purple));
    }
    .chart-title {
      font-size: 15px; font-weight: 600;
      color: var(--ios-text2);
      margin-bottom: 16px;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 180px;
      gap: 12px;
      padding-top: 20px;
    }
    .bar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      height: 100%;
      justify-content: flex-end;
    }
    .bar-value {
      font-size: 13px; font-weight: 700;
      margin-bottom: 6px;
      color: var(--ios-text);
    }
    .bar {
      width: 100%;
      max-width: 60px;
      border-radius: 6px 6px 0 0;
      min-height: 4px;
      transition: height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .bar.platinum { background: linear-gradient(135deg, #9B59B6, #8E44AD); }
    .bar.gold { background: linear-gradient(135deg, #F39C12, #E67E22); }
    .bar.silver { background: linear-gradient(135deg, #BDC3C7, #95A5A6); }
    .bar.general { background: var(--ios-gray5); }
    .bar.green { background: var(--ios-green); }
    .bar.red { background: var(--ios-red); }
    .bar-label {
      font-size: 12px; font-weight: 500;
      color: var(--ios-text3);
      margin-top: 8px;
      text-align: center;
    }

    /* â”€â”€ Escalation Reasons Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reasons-card {
      background: var(--ios-card);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      position: relative;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .reasons-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--ios-blue), var(--ios-purple));
    }
    .reason-row {
      display: flex; align-items: center; gap: 12px;
      padding: 8px 0;
    }
    .reason-row + .reason-row {
      border-top: 1px solid var(--ios-separator);
    }
    .reason-label {
      flex: 0 0 260px;
      font-size: 13px;
      color: var(--ios-text2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .reason-bar-wrap {
      flex: 1;
      height: 8px;
      background: var(--ios-gray6);
      border-radius: 4px;
      overflow: hidden;
    }
    .reason-bar {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--ios-blue), var(--ios-purple));
      transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .reason-count {
      flex: 0 0 30px;
      font-size: 14px;
      font-weight: 700;
      text-align: right;
      color: var(--ios-text);
    }

    /* â”€â”€ Skeleton loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .skeleton { position: relative; overflow: hidden; }
    .skeleton-line {
      height: 16px; border-radius: 8px;
      background: var(--ios-gray6);
      margin-bottom: 8px;
    }
    .skeleton-line.big { height: 42px; width: 80px; margin-bottom: 12px; }

    @media (prefers-reduced-motion: no-preference) {
      .skeleton-line {
        animation: skeleton-pulse 1.5s ease-in-out infinite;
      }
      @keyframes skeleton-pulse {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 1; }
      }
    }

    /* â”€â”€ Dark mode overrides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (prefers-color-scheme: dark) {
      .dash-nav {
        background: rgba(28,28,30,0.92);
      }
      .tier-badge.Silver { color: #fff; }
      .tier-badge.General { color: #ccc; }
    }

    /* â”€â”€ KB Test Bed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kb-testbed {
      background: var(--ios-card);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      position: relative;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .kb-testbed::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #34C759, #007AFF, #AF52DE);
    }
    .kb-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 6px;
    }
    .kb-status {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 500;
      color: var(--ios-text2);
    }
    .kb-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--ios-green);
      display: inline-block;
    }
    .kb-dot.loading { background: var(--ios-orange); animation: pulse-dot 1s infinite; }
    .kb-dot.error { background: var(--ios-red); }
    @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.3} }

    .kb-desc {
      font-size: 13px; color: var(--ios-text3);
      margin-bottom: 14px; line-height: 1.5;
    }
    .kb-presets {
      display: flex; align-items: center; gap: 8px;
      flex-wrap: wrap; margin-bottom: 14px;
    }
    .kb-preset-label {
      font-size: 12px; font-weight: 600;
      color: var(--ios-text3); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .kb-preset {
      font-family: inherit; font-size: 13px; font-weight: 500;
      padding: 5px 12px; border-radius: 16px;
      border: 1px solid var(--ios-blue);
      background: transparent; color: var(--ios-blue);
      cursor: pointer; transition: all 0.15s;
    }
    .kb-preset:hover {
      background: var(--ios-blue); color: #fff;
    }
    .kb-preset.non-kb {
      border-color: var(--ios-orange); color: var(--ios-orange);
    }
    .kb-preset.non-kb:hover {
      background: var(--ios-orange); color: #fff;
    }

    .kb-input-row {
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    .kb-input {
      flex: 1; font-family: inherit; font-size: 15px;
      padding: 10px 14px; border-radius: 10px;
      border: 1px solid var(--ios-separator);
      background: var(--ios-bg); color: var(--ios-text);
      outline: none; transition: border 0.15s;
    }
    .kb-input:focus { border-color: var(--ios-blue); }
    .kb-send {
      font-family: inherit; font-size: 15px; font-weight: 600;
      padding: 10px 20px; border-radius: 10px; border: none;
      background: var(--ios-blue); color: #fff;
      cursor: pointer; white-space: nowrap; transition: opacity 0.15s;
    }
    .kb-send:hover { opacity: 0.85; }
    .kb-send:disabled { opacity: 0.4; cursor: not-allowed; }

    .kb-results { margin-top: 4px; }
    .kb-result-header {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 14px; flex-wrap: wrap;
    }
    .kb-source-badge {
      font-size: 13px; font-weight: 700;
      padding: 4px 14px; border-radius: 16px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .kb-source-badge.kb { background: #34C75920; color: var(--ios-green); border: 1px solid var(--ios-green); }
    .kb-source-badge.bedrock { background: #007AFF20; color: var(--ios-blue); border: 1px solid var(--ios-blue); }
    .kb-source-badge.fallback { background: #FF950020; color: var(--ios-orange); border: 1px solid var(--ios-orange); }
    .kb-source-badge.error { background: #FF3B3020; color: var(--ios-red); border: 1px solid var(--ios-red); }

    .kb-routing {
      font-size: 13px; color: var(--ios-text2);
    }
    .kb-latency {
      font-size: 12px; color: var(--ios-text3);
      margin-left: auto;
    }

    .kb-response-box, .kb-citations-box {
      background: var(--ios-bg);
      border-radius: 10px; padding: 14px;
      margin-bottom: 12px;
    }
    .kb-response-label {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--ios-text3);
      margin-bottom: 8px;
    }
    .kb-response-text {
      font-size: 14px; line-height: 1.6;
      color: var(--ios-text); white-space: pre-wrap;
    }

    .kb-citation {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 8px 0; font-size: 13px;
    }
    .kb-citation + .kb-citation { border-top: 1px solid var(--ios-separator); }
    .kb-citation-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
    .kb-citation-source {
      font-weight: 600; color: var(--ios-blue); font-size: 12px;
      word-break: break-all;
    }
    .kb-citation-snippet {
      font-size: 12px; color: var(--ios-text2); margin-top: 2px;
      line-height: 1.4;
    }

    .kb-raw-toggle {
      margin-top: 8px;
    }
    .kb-raw-toggle summary {
      font-size: 12px; color: var(--ios-text3); cursor: pointer;
      font-weight: 600; padding: 4px 0;
    }
    .kb-raw-json {
      font-family: 'SF Mono', 'Menlo', monospace;
      font-size: 11px; line-height: 1.5;
      background: var(--ios-bg); color: var(--ios-text2);
      border-radius: 8px; padding: 12px;
      max-height: 300px; overflow: auto;
      white-space: pre-wrap; word-break: break-all;
      margin-top: 8px;
    }

    .kb-history { margin-top: 16px; }
    .kb-history-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0; font-size: 13px; cursor: pointer;
    }
    .kb-history-item + .kb-history-item { border-top: 1px solid var(--ios-separator); }
    .kb-history-item:hover { color: var(--ios-blue); }
    .kb-history-q { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .kb-history-src {
      font-size: 11px; font-weight: 700;
      padding: 2px 8px; border-radius: 10px;
    }
    .kb-history-src.kb { background: #34C75920; color: var(--ios-green); }
    .kb-history-src.bedrock { background: #007AFF20; color: var(--ios-blue); }
    .kb-history-src.fallback { background: #FF950020; color: var(--ios-orange); }
    .kb-history-src.error { background: #FF3B3020; color: var(--ios-red); }
    .kb-history-time { font-size: 11px; color: var(--ios-text3); flex-shrink: 0; }

    @media (prefers-color-scheme: dark) {
      .kb-input { background: #2C2C2E; border-color: #3A3A3C; }
      .kb-response-box, .kb-citations-box { background: #2C2C2E; }
      .kb-raw-json { background: #2C2C2E; }
    }



    @media (prefers-reduced-motion: no-preference) {
      .kpi-card, .chart-card, .reasons-card {
        animation: card-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both;
      }
      @keyframes card-in {
        from { opacity: 0; transform: translateY(16px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
  </style>
</head>
<body>

  <!-- â•â•â•â•â•â• Nav Bar â•â•â•â•â•â• -->
  <header class="dash-nav">
    <div class="dash-nav-inner">
      <a href="index.html" class="nav-back">â† Customer View</a>
      <div class="dash-title">ğŸ“Š Support Team Dashboard</div>
      <div class="dash-controls">
        <select class="dash-select" id="timeFilter">
          <option value="1h">Last 1 Hour</option>
          <option value="24h">Last 24 Hours</option>
          <option value="7d" selected>Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
        </select>
        <button class="dash-refresh" id="btnRefresh" title="Refresh">ğŸ”„</button>
      </div>
      <div class="dash-timestamp">Last updated: <span id="timestamp">â€”</span></div>
    </div>
  </header>

  <main class="dash-container">

    <!-- â•â•â•â•â•â• KPI Cards â•â•â•â•â•â• -->
    <section class="kpi-grid" id="kpiGrid">
      <!-- Escalation Card -->
      <div class="kpi-card escalation">
        <div class="kpi-label">Agent Escalations</div>
        <div class="kpi-value" id="escTotal">â€”</div>
        <div id="escTiers"></div>
      </div>
      <!-- Confirmed Card -->
      <div class="kpi-card confirmed">
        <div class="kpi-label">Confirmed Rebookings</div>
        <div class="kpi-value green" id="confTotal">â€”</div>
        <div id="confTiers"></div>
      </div>
      <!-- Failed Card -->
      <div class="kpi-card failed">
        <div class="kpi-label">Failed Rebookings</div>
        <div class="kpi-value red" id="failTotal">â€”</div>
        <div class="stat-row">
          <span class="stat-label">Failure Rate</span>
          <span class="stat-val orange" id="failRate">â€”</span>
        </div>
        <div id="failTiers"></div>
      </div>
      <!-- Open Rebookings Card -->
      <div class="kpi-card failed" id="openRebookingsCard" style="cursor: pointer;">
        <div class="kpi-label">Open Rebookings</div>
        <div class="kpi-value red" id="openRebookingsCount">â€”</div>
        <div style="font-size: 12px; color: var(--ios-text2); margin-top: 8px;">Click to view pending customers â†’</div>
      </div>
      <!-- Key Metrics Card -->
      <div class="kpi-card summary">
        <div class="kpi-label">Key Metrics</div>
        <div class="stat-row">
          <span class="stat-label">Success Rate</span>
          <span class="stat-val green" id="successRate">â€”</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Agent Requests</span>
          <span class="stat-val orange" id="agentPct">â€”</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Sessions</span>
          <span class="stat-val" id="totalSessions">â€”</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Active Disruptions</span>
          <span class="stat-val" id="totalDisruptions">â€”</span>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â• Bar Charts â•â•â•â•â•â• -->
    <section class="chart-grid" id="chartGrid">
      <div class="chart-card">
        <div class="chart-title">Escalation Requests by Tier</div>
        <div class="bar-chart" id="chartEscalations"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Confirmed Rebookings by Tier</div>
        <div class="bar-chart" id="chartConfirmed"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Failed Rebookings by Tier</div>
        <div class="bar-chart" id="chartFailed"></div>
      </div>
    </section>

    <!-- â•â•â•â•â•â• Escalation Reasons â•â•â•â•â•â• -->
    <section class="reasons-card">
      <div class="chart-title">Top Escalation Reasons</div>
      <div id="reasonsList"></div>
    </section>

    <!-- â•â•â•â•â•â• Knowledge Base Test Bed â•â•â•â•â•â• -->
    <section class="kb-testbed" id="kbTestbed">
      <div class="kb-header">
        <div class="chart-title" style="margin-bottom:0">ğŸ§ª Knowledge Base Test Bed</div>
        <div class="kb-status" id="kbStatus">
          <span class="kb-dot" id="kbDot"></span>
          <span id="kbStatusText">Ready</span>
        </div>
      </div>
      <p class="kb-desc">Send policy questions to verify Knowledge Base (RAG) integration. Responses show the source, citations, and whether the answer came from the real KB or a fallback.</p>

      <!-- Preset Queries -->
      <div class="kb-presets">
        <span class="kb-preset-label">Quick tests:</span>
        <button class="kb-preset" data-q="Am I entitled to compensation for my delayed flight?">Compensation</button>
        <button class="kb-preset" data-q="What are my rights under EU261?">EU261 Rights</button>
        <button class="kb-preset" data-q="Can I get a hotel if my flight is delayed overnight?">Hotel/Care</button>
        <button class="kb-preset" data-q="How is my personal data handled under GDPR?">GDPR</button>
        <button class="kb-preset" data-q="How long does a refund take?">Refund Time</button>
        <button class="kb-preset" data-q="I need a new flight">Non-KB (Chat)</button>
      </div>

      <!-- Input -->
      <div class="kb-input-row">
        <select class="dash-select" id="kbTier" style="flex:0 0 auto">
          <option value="Platinum">Platinum</option>
          <option value="Gold" selected>Gold</option>
          <option value="Silver">Silver</option>
          <option value="General">General</option>
        </select>
        <input type="text" class="kb-input" id="kbQuery" placeholder="Type a question to test KB routingâ€¦" />
        <button class="kb-send" id="kbSend">Send â†’</button>
      </div>

      <!-- Results -->
      <div class="kb-results" id="kbResults" style="display:none">
        <!-- Source Badge -->
        <div class="kb-result-header">
          <div class="kb-source-badge" id="kbSourceBadge">â€”</div>
          <div class="kb-routing" id="kbRouting">â€”</div>
          <div class="kb-latency" id="kbLatency">â€”</div>
        </div>

        <!-- Response Text -->
        <div class="kb-response-box">
          <div class="kb-response-label">Response</div>
          <div class="kb-response-text" id="kbResponseText"></div>
        </div>

        <!-- Citations -->
        <div class="kb-citations-box" id="kbCitationsBox" style="display:none">
          <div class="kb-response-label">Citations</div>
          <div id="kbCitationsList"></div>
        </div>

        <!-- Raw JSON Toggle -->
        <details class="kb-raw-toggle">
          <summary>Raw API Response</summary>
          <pre class="kb-raw-json" id="kbRawJson"></pre>
        </details>
      </div>

      <!-- History -->
      <div class="kb-history" id="kbHistory" style="display:none">
        <div class="kb-response-label">Test History</div>
        <div id="kbHistoryList"></div>
      </div>
    </section>

  </main>

  <script src="js/config.js"></script>
  <script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // API_BASE_URL is loaded from config.js (patched by upload-web.py on deploy)
    // Falls back to localhost for local development
    if (typeof API_BASE_URL === 'undefined') window.API_BASE_URL = 'http://127.0.0.1:3000';
    const _API = (typeof API_BASE_URL !== 'undefined') ? API_BASE_URL : 'http://127.0.0.1:3000';

    const FALLBACK_DATA = {
      timestamp: new Date().toISOString(),
      timeRange: '7d',
      escalations: {
        total: 12,
        byTier: { Platinum: 5, Gold: 4, Silver: 2, General: 1 },
        byReason: {
          'Customer requested agent assistance': 4,
          'Sentiment auto-escalation (negative)': 3,
          'Wheelchair assistance needed': 2,
          'Complex rebooking scenario': 2,
          'Compensation inquiry': 1,
        },
      },
      rebookings: {
        total: 28,
        confirmed: 20,
        byTier: { Platinum: 10, Gold: 9, Silver: 6, General: 3 },
        successRate: '71.43',
      },
      failedRebookings: {
        total: 8,
        byTier: { Platinum: 2, Gold: 3, Silver: 2, General: 1 },
        failureRate: '28.57',
      },
      disruptions: { total: 3, byType: { CANCELLATION: 2, DELAY: 1 } },
      summary: { totalSessions: 40, agentRequestsPercentage: '30.00' },
    };

    const TIERS = ['Platinum', 'Gold', 'Silver', 'General'];

    // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const timeFilter = document.getElementById('timeFilter');
    const btnRefresh = document.getElementById('btnRefresh');
    const elTimestamp = document.getElementById('timestamp');

    // â”€â”€ Load dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDashboard() {
      try {
        const range = timeFilter.value;
        const resp = await fetch(`${_API}/dashboard?timeRange=${range}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        renderDashboard(data);
      } catch (err) {
        console.warn('Dashboard API unavailable, using fallback data:', err.message);
        renderDashboard(FALLBACK_DATA);
      }
    }

    // â”€â”€ Render dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderDashboard(data) {
      // Timestamp
      elTimestamp.textContent = new Date(data.timestamp).toLocaleString();

      // KPIs
      document.getElementById('escTotal').textContent = data.escalations.total;
      document.getElementById('confTotal').textContent = data.rebookings.confirmed;
      document.getElementById('failTotal').textContent = data.failedRebookings.total;
      document.getElementById('failRate').textContent = data.failedRebookings.failureRate + '%';
      document.getElementById('successRate').textContent = data.rebookings.successRate + '%';
      document.getElementById('agentPct').textContent = data.summary.agentRequestsPercentage + '%';
      document.getElementById('totalSessions').textContent = data.summary.totalSessions;
      document.getElementById('totalDisruptions').textContent = data.disruptions.total;

      // Tier breakdowns for KPI cards
      renderTierRows('escTiers', data.escalations.byTier);
      renderTierRows('confTiers', data.rebookings.byTier);
      renderTierRows('failTiers', data.failedRebookings.byTier);

      // Compute global max across all 3 chart datasets for proportional bars
      const allValues = [
        ...Object.values(data.escalations.byTier || {}),
        ...Object.values(data.rebookings.byTier || {}),
        ...Object.values(data.failedRebookings.byTier || {}),
      ];
      const globalMax = Math.max(1, ...allValues);

      // Charts
      renderEscalationChart(data.escalations.byTier, globalMax);
      renderRebookingChart(data.rebookings.byTier, globalMax);
      renderFailedRebookingChart(data.failedRebookings.byTier, globalMax);

      // Reasons
      renderEscalationReasons(data.escalations.byReason);
    }

    function renderTierRows(containerId, byTier) {
      const el = document.getElementById(containerId);
      el.innerHTML = TIERS.map(t => `
        <div class="tier-row">
          <span class="tier-badge ${t}">${t}</span>
          <span>${byTier[t] || 0}</span>
        </div>
      `).join('');
    }

    // â”€â”€ Bar Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderEscalationChart(byTier, globalMax) {
      const el = document.getElementById('chartEscalations');
      el.innerHTML = TIERS.map(t => {
        const val = byTier[t] || 0;
        const pct = globalMax > 0 ? (val / globalMax * 100) : 0;
        return `<div class="bar-col">
          <div class="bar-value">${val}</div>
          <div class="bar ${t.toLowerCase()}" style="height:${pct}%"></div>
          <div class="bar-label">${t}</div>
        </div>`;
      }).join('');
    }

    function renderRebookingChart(byTier, globalMax) {
      const el = document.getElementById('chartConfirmed');
      el.innerHTML = TIERS.map(t => {
        const val = byTier[t] || 0;
        const pct = globalMax > 0 ? (val / globalMax * 100) : 0;
        return `<div class="bar-col">
          <div class="bar-value">${val}</div>
          <div class="bar green" style="height:${pct}%"></div>
          <div class="bar-label">${t}</div>
        </div>`;
      }).join('');
    }

    function renderFailedRebookingChart(byTier, globalMax) {
      const el = document.getElementById('chartFailed');
      el.innerHTML = TIERS.map(t => {
        const val = byTier[t] || 0;
        const pct = globalMax > 0 ? (val / globalMax * 100) : 0;
        return `<div class="bar-col">
          <div class="bar-value">${val}</div>
          <div class="bar red" style="height:${pct}%"></div>
          <div class="bar-label">${t}</div>
        </div>`;
      }).join('');
    }

    // â”€â”€ Escalation Reasons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderEscalationReasons(byReason) {
      const el = document.getElementById('reasonsList');
      if (!byReason || Object.keys(byReason).length === 0) {
        el.innerHTML = '<div style="color:var(--ios-text3);font-size:14px;padding:12px 0">No escalation data in this time range</div>';
        return;
      }
      const sorted = Object.entries(byReason).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const max = sorted[0][1] || 1;
      el.innerHTML = sorted.map(([reason, count]) => {
        const pct = (count / max * 100).toFixed(0);
        return `<div class="reason-row">
          <span class="reason-label" title="${reason}">${reason}</span>
          <div class="reason-bar-wrap"><div class="reason-bar" style="width:${pct}%"></div></div>
          <span class="reason-count">${count}</span>
        </div>`;
      }).join('');
    }

    // â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    timeFilter.addEventListener('change', loadDashboard);
    btnRefresh.addEventListener('click', loadDashboard);

    // Toggle back to customer view (Ctrl+Shift+D / Cmd+Shift+D)
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        window.location.href = 'index.html';
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ Knowledge Base Test Bed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const kbQuery = document.getElementById('kbQuery');
    const kbSend = document.getElementById('kbSend');
    const kbTier = document.getElementById('kbTier');
    const kbResults = document.getElementById('kbResults');
    const kbDot = document.getElementById('kbDot');
    const kbStatusText = document.getElementById('kbStatusText');
    const kbHistory = document.getElementById('kbHistory');
    const kbHistoryList = document.getElementById('kbHistoryList');

    let _kbSessionId = null; // reusable session for KB tests
    const _kbTestHistory = [];

    // Source classification helper
    function classifySource(source) {
      if (!source) return { cls: 'fallback', label: 'UNKNOWN', desc: 'No source returned' };
      if (source === 'knowledge-base') return { cls: 'kb', label: 'KNOWLEDGE BASE', desc: 'Answer from Bedrock KB (RAG) with real document retrieval' };
      if (source === 'bedrock') return { cls: 'bedrock', label: 'BEDROCK CHAT', desc: 'Direct Claude chat â€” not routed to KB (not a policy question)' };
      if (source.includes('error')) return { cls: 'error', label: 'ERROR â†’ FALLBACK', desc: 'KB/Bedrock call failed, using hardcoded fallback' };
      return { cls: 'fallback', label: 'FALLBACK', desc: 'Hardcoded response â€” KB not reached (check KNOWLEDGE_BASE_ID env var)' };
    }

    // Determine if citations are real (S3) or mock (local paths)
    function citationsAreReal(citations) {
      if (!citations || citations.length === 0) return false;
      for (const c of citations) {
        for (const r of (c.references || [])) {
          if (r.location && r.location.startsWith('s3://')) return true;
        }
        // Also check flat citation format
        if (c.uri && c.uri.startsWith('s3://')) return true;
      }
      return false;
    }

    // Ensure we have a session for KB testing
    async function ensureKbSession(tier) {
      if (_kbSessionId) return _kbSessionId;
      setKbStatus('loading', 'Creating test sessionâ€¦');
      const resp = await fetch(`${_API}/disruption`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'delay', reason: 'mechanical', airport: 'FRA',
          passenger: { firstName: 'KBTest', tier: tier || 'Gold', origin: 'FRA', destination: 'JFK', flightNumber: 'UA9999' }
        }),
      });
      if (!resp.ok) throw new Error(`Disruption API returned ${resp.status}`);
      const data = await resp.json();
      _kbSessionId = data.sessionId;
      return _kbSessionId;
    }

    function setKbStatus(state, text) {
      kbDot.className = 'kb-dot' + (state === 'loading' ? ' loading' : state === 'error' ? ' error' : '');
      kbStatusText.textContent = text || (state === 'loading' ? 'Queryingâ€¦' : state === 'error' ? 'Error' : 'Ready');
    }

    // Main send handler
    async function sendKbTest() {
      const query = kbQuery.value.trim();
      if (!query) return;
      kbSend.disabled = true;
      kbResults.style.display = 'none';
      setKbStatus('loading', 'Sending to APIâ€¦');
      const t0 = performance.now();

      try {
        const sessionId = await ensureKbSession(kbTier.value);
        setKbStatus('loading', 'Waiting for responseâ€¦');

        const resp = await fetch(`${_API}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, message: query }),
        });
        const data = await resp.json();
        const elapsed = Math.round(performance.now() - t0);

        if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);

        // Classify and render
        const info = classifySource(data.source);
        const realCitations = citationsAreReal(data.citations);

        // Source badge
        const badge = document.getElementById('kbSourceBadge');
        badge.textContent = info.label;
        badge.className = 'kb-source-badge ' + info.cls;

        // Routing explanation
        const routing = document.getElementById('kbRouting');
        let routeHtml = info.desc;
        if (info.cls === 'kb' && !realCitations) {
          routeHtml += ' <span style="color:var(--ios-orange);font-weight:600">âš  Citations are mock (local paths) â€” KB may not have returned real docs</span>';
        }
        if (info.cls === 'kb' && realCitations) {
          routeHtml += ' <span style="color:var(--ios-green);font-weight:600">âœ“ Real S3 citations</span>';
        }
        routing.innerHTML = routeHtml;

        // Latency
        document.getElementById('kbLatency').textContent = `${elapsed}ms`;

        // Response text
        document.getElementById('kbResponseText').textContent = data.assistant || data.text || '(empty response)';

        // Citations
        const citBox = document.getElementById('kbCitationsBox');
        const citList = document.getElementById('kbCitationsList');
        const citations = data.citations || [];
        if (citations.length > 0) {
          citBox.style.display = '';
          citList.innerHTML = citations.map(c => {
            // Handle both nested (KB real) and flat (fallback) citation formats
            const refs = c.references || [];
            if (refs.length > 0) {
              return refs.map(r => `<div class="kb-citation">
                <span class="kb-citation-icon">${r.location && r.location.startsWith('s3://') ? 'ğŸ“„' : 'ğŸ“‹'}</span>
                <div>
                  <div class="kb-citation-source">${r.location || 'unknown'}</div>
                  ${r.content ? `<div class="kb-citation-snippet">${r.content}</div>` : ''}
                </div>
              </div>`).join('');
            }
            // Flat citation format (fallback)
            return `<div class="kb-citation">
              <span class="kb-citation-icon">ğŸ“‹</span>
              <div>
                <div class="kb-citation-source">${c.uri || c.title || 'unknown'}</div>
                ${c.text ? `<div class="kb-citation-snippet">${c.text}</div>` : ''}
              </div>
            </div>`;
          }).join('');
        } else {
          citBox.style.display = 'none';
          citList.innerHTML = '';
        }

        // Raw JSON
        document.getElementById('kbRawJson').textContent = JSON.stringify(data, null, 2);

        kbResults.style.display = '';
        setKbStatus('ok', `âœ“ ${info.label} â€” ${elapsed}ms`);

        // Add to history
        _kbTestHistory.unshift({ query, source: data.source, cls: info.cls, label: info.label, elapsed, time: new Date() });
        renderKbHistory();

      } catch (err) {
        setKbStatus('error', `Error: ${err.message}`);
        // Show error in results
        document.getElementById('kbSourceBadge').textContent = 'ERROR';
        document.getElementById('kbSourceBadge').className = 'kb-source-badge error';
        document.getElementById('kbRouting').textContent = err.message;
        document.getElementById('kbLatency').textContent = Math.round(performance.now() - t0) + 'ms';
        document.getElementById('kbResponseText').textContent = `Request failed: ${err.message}`;
        document.getElementById('kbCitationsBox').style.display = 'none';
        document.getElementById('kbRawJson').textContent = JSON.stringify({ error: err.message }, null, 2);
        kbResults.style.display = '';
      } finally {
        kbSend.disabled = false;
      }
    }

    function renderKbHistory() {
      if (_kbTestHistory.length === 0) { kbHistory.style.display = 'none'; return; }
      kbHistory.style.display = '';
      kbHistoryList.innerHTML = _kbTestHistory.slice(0, 10).map(h => `
        <div class="kb-history-item" onclick="document.getElementById('kbQuery').value='${h.query.replace(/'/g, "\\'")}'">
          <span class="kb-history-src ${h.cls}">${h.label}</span>
          <span class="kb-history-q">${h.query}</span>
          <span class="kb-history-time">${h.elapsed}ms Â· ${h.time.toLocaleTimeString()}</span>
        </div>
      `).join('');
    }

    // Wire events
    kbSend.addEventListener('click', sendKbTest);
    kbQuery.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendKbTest(); });

    // Preset buttons
    document.querySelectorAll('.kb-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        kbQuery.value = btn.dataset.q;
        sendKbTest();
      });
    });

    // â”€â”€ Open Rebookings Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const openRebookingsCard = document.getElementById('openRebookingsCard');
    
    async function showOpenRebookings() {
      try {
        const resp = await fetch(`${API_BASE_URL}/open-rebookings`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        
        let allRebookings = data.openRebookings;
        let filteredRebookings = [...allRebookings];
        let expandedSessionId = null;

        // Create modal
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.5); z-index: 1000;
          display: flex; align-items: center; justify-content: center;
          backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: var(--ios-card); max-width: 900px; max-height: 700px;
          border-radius: 12px; overflow: hidden;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          display: flex; flex-direction: column;
        `;
        
        const header = document.createElement('div');
        header.style.cssText = `
          padding: 16px 20px; border-bottom: 1px solid var(--ios-separator);
          display: flex; justify-content: space-between; align-items: center;
        `;
        header.innerHTML = `
          <div style="font-size:16px;font-weight:600;">Open Rebookings (<span id="rebookingCount">${data.openRebookingsCount}</span>)</div>
          <button style="background:none;border:none;font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;" id="closeModal">âœ•</button>
        `;
        
        // Create filters section
        const filtersContainer = document.createElement('div');
        filtersContainer.style.cssText = `
          padding: 12px 20px; border-bottom: 1px solid var(--ios-separator);
          background: var(--ios-bg);
          display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;
        `;
        filtersContainer.innerHTML = `
          <input type="text" id="filterCustomerName" placeholder="Search by name..." style="
            padding: 8px; border: 1px solid var(--ios-separator); border-radius: 6px;
            background: var(--ios-card); color: var(--ios-text); font-size: 13px;
            font-family: inherit;
          ">
          <select id="filterStatus" style="
            padding: 8px; border: 1px solid var(--ios-separator); border-radius: 6px;
            background: var(--ios-card); color: var(--ios-text); font-size: 13px;
            font-family: inherit;
          ">
            <option value="">All Status</option>
            <option value="CANCELLED">Cancelled</option>
            <option value="DELAYED">Delayed</option>
          </select>
          <select id="filterTier" style="
            padding: 8px; border: 1px solid var(--ios-separator); border-radius: 6px;
            background: var(--ios-card); color: var(--ios-text); font-size: 13px;
            font-family: inherit;
          ">
            <option value="">All Tiers</option>
            <option value="Platinum">Platinum</option>
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
            <option value="General">General</option>
          </select>
          <button id="clearFilters" style="
            padding: 8px 12px; border: 1px solid var(--ios-separator); border-radius: 6px;
            background: var(--ios-card); color: var(--ios-text); font-size: 13px;
            cursor: pointer; font-family: inherit; font-weight: 500;
          ">Clear Filters</button>
        `;
        
        const listContainer = document.createElement('div');
        listContainer.style.cssText = `
          flex: 1; overflow-y: auto; padding: 12px;
        `;
        
        function renderList() {
          if (filteredRebookings.length === 0) {
            listContainer.innerHTML = '<div style="padding:20px;text-align:center;color:var(--ios-text2);">No matching rebookings</div>';
            return;
          }
          
          listContainer.innerHTML = filteredRebookings.map(item => `
            <div data-session-id="${item.sessionId}" style="
              background: var(--ios-bg); padding: 12px;
              margin-bottom: 8px; border-radius: 8px;
              border-left: 4px solid var(--ios-red);
              cursor: pointer; transition: all 0.2s;
            " class="rebooking-row" onmouseover="this.style.backgroundColor='var(--ios-gray6)'" onmouseout="this.style.backgroundColor='var(--ios-bg)'">
              <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                <div style="font-weight:600;font-size:14px;">${item.customerName}</div>
                <span style="font-size:12px;background:var(--ios-red);color:white;padding:2px 6px;border-radius:4px;">${item.status}</span>
              </div>
              <div style="font-size:13px;color:var(--ios-text2);margin-bottom:4px;">
                ${item.originCode} â†’ ${item.destCode} â€¢ ${item.flightNumber}
              </div>
              <div style="font-size:12px;color:var(--ios-text3);margin-bottom:2px;">
                Scheduled: ${item.originalScheduledTime}
              </div>
              <div style="font-size:12px;color:var(--ios-text3);margin-bottom:4px;">
                Tier: <span style="font-weight:500;">${item.passengerTier}</span>
              </div>
              <button onclick="event.stopPropagation()" style="
                font-size:12px; padding:4px 8px; background:var(--ios-blue); color:white;
                border:none; border-radius:4px; cursor:pointer; margin-top:4px;
                font-family: inherit; font-weight: 500;
              ">Rebook Now â†’</button>
            </div>
          `).join('');
          
          // Add click handlers for rows
          document.querySelectorAll('.rebooking-row').forEach(row => {
            row.addEventListener('click', (e) => {
              const sessionId = row.dataset.sessionId;
              const item = filteredRebookings.find(r => r.sessionId === sessionId);
              showCustomerDetails(item);
            });
          });
        }
        
        function applyFilters() {
          const name = document.getElementById('filterCustomerName').value.toLowerCase();
          const status = document.getElementById('filterStatus').value;
          const tier = document.getElementById('filterTier').value;
          
          filteredRebookings = allRebookings.filter(item => {
            const nameMatch = item.customerName.toLowerCase().includes(name);
            const statusMatch = !status || item.status === status;
            const tierMatch = !tier || item.passengerTier === tier;
            return nameMatch && statusMatch && tierMatch;
          });
          
          document.getElementById('rebookingCount').textContent = filteredRebookings.length;
          renderList();
        }
        
        function showCustomerDetails(item) {
          const detailsModal = document.createElement('div');
          detailsModal.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 1001;
            display: flex; align-items: center; justify-content: center;
          `;
          
          const detailsContent = document.createElement('div');
          detailsContent.style.cssText = `
            background: var(--ios-card); max-width: 600px; border-radius: 12px;
            padding: 24px; box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            max-height: 600px; overflow-y: auto;
          `;
          
          detailsContent.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
              <h2 style="margin:0;font-size:18px;font-weight:600;">${item.customerName}</h2>
              <button onclick="this.closest('[style*=\\\"position: fixed\\\"]').remove()" style="
                background:none;border:none;font-size:20px;cursor:pointer;padding:0;
              ">âœ•</button>
            </div>
            
            <div style="background:var(--ios-bg);padding:12px;border-radius:8px;margin-bottom:16px;">
              <div style="font-size:13px;color:var(--ios-text2);font-weight:600;margin-bottom:8px;">DISRUPTED FLIGHT</div>
              <div style="font-size:14px;margin-bottom:4px;">
                <strong>Flight:</strong> ${item.flightNumber}
              </div>
              <div style="font-size:14px;margin-bottom:4px;">
                <strong>Route:</strong> ${item.originCode} â†’ ${item.destCode}
              </div>
              <div style="font-size:14px;margin-bottom:4px;">
                <strong>Scheduled:</strong> ${item.originalScheduledTime}
              </div>
              <div style="font-size:14px;">
                <strong>Status:</strong> <span style="color:var(--ios-red);font-weight:600;">${item.status}</span>
              </div>
            </div>
            
            <div style="background:var(--ios-bg);padding:12px;border-radius:8px;margin-bottom:16px;">
              <div style="font-size:13px;color:var(--ios-text2);font-weight:600;margin-bottom:8px;">PASSENGER INFO</div>
              <div style="font-size:14px;margin-bottom:4px;">
                <strong>Name:</strong> ${item.customerName}
              </div>
              <div style="font-size:14px;margin-bottom:4px;">
                <strong>Tier:</strong> <span style="font-weight:500;">${item.passengerTier}</span>
              </div>
              <div style="font-size:14px;">
                <strong>Session ID:</strong> <code style="font-family:monospace;font-size:12px;background:var(--ios-card);padding:2px 4px;border-radius:3px;">${item.sessionId}</code>
              </div>
            </div>
            
            <div style="background:var(--ios-bg);padding:12px;border-radius:8px;margin-bottom:16px;">
              <div style="font-size:13px;color:var(--ios-text2);font-weight:600;margin-bottom:8px;">DISRUPTION REASON</div>
              <div style="font-size:14px;color:var(--ios-text);">${item.reason}</div>
            </div>
            
            <div style="display:flex;gap:8px;margin-top:20px;">
              <button onclick="alert('Opening rebooking flow for ' + '${item.customerName}...');this.closest('[style*=\\\"position: fixed\\\"]').remove()" style="
                flex:1; padding:12px; background:var(--ios-blue); color:white;
                border:none; border-radius:8px; cursor:pointer; font-weight:600;
                font-family:inherit; font-size:14px;
              ">Initiate Rebooking</button>
              <button onclick="this.closest('[style*=\\\"position: fixed\\\"]').remove()" style="
                flex:1; padding:12px; background:var(--ios-gray5); color:var(--ios-text);
                border:none; border-radius:8px; cursor:pointer; font-weight:600;
                font-family:inherit; font-size:14px;
              ">Close</button>
            </div>
          `;
          
          detailsModal.appendChild(detailsContent);
          document.body.appendChild(detailsModal);
        }
        
        modalContent.appendChild(header);
        modalContent.appendChild(filtersContainer);
        modalContent.appendChild(listContainer);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Render initial list
        renderList();
        
        // Filter event listeners
        const nameInput = filtersContainer.querySelector('#filterCustomerName');
        const statusSelect = filtersContainer.querySelector('#filterStatus');
        const tierSelect = filtersContainer.querySelector('#filterTier');
        const clearBtn = filtersContainer.querySelector('#clearFilters');
        
        nameInput.addEventListener('input', applyFilters);
        statusSelect.addEventListener('change', applyFilters);
        tierSelect.addEventListener('change', applyFilters);
        clearBtn.addEventListener('click', () => {
          nameInput.value = '';
          statusSelect.value = '';
          tierSelect.value = '';
          applyFilters();
        });
        
        // Close handlers
        const closeBtn = header.querySelector('#closeModal');
        closeBtn.addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
      } catch (err) {
        console.error('Failed to load open rebookings:', err);
        alert('Failed to load open rebookings');
      }
    }
    
    if (openRebookingsCard) {
      openRebookingsCard.addEventListener('click', showOpenRebookings);
    }

    // Style the non-KB preset differently
    document.querySelectorAll('.kb-preset').forEach(btn => {
      if (btn.dataset.q === 'I need a new flight') btn.classList.add('non-kb');
    });

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadOpenRebookingsCount() {
      try {
        const resp = await fetch(`${API_BASE_URL}/open-rebookings`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const el = document.getElementById('openRebookingsCount');
        if (el) el.textContent = data.openRebookingsCount;
      } catch (err) {
        console.warn('Failed to load open rebookings count:', err);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      loadOpenRebookingsCount();
    });
    setInterval(() => {
      loadDashboard();
      loadOpenRebookingsCount();
    }, 30000);
  </script>
</body>
</html>
